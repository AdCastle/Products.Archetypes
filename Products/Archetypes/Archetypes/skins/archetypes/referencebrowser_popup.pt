<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      i18n:domain="plone">

<head tal:define="ztu modules/ZTUtils;">
    <title tal:content="here/title_or_id">Title or Id</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"
              tal:define="charset here/portal_properties/site_properties/default_charset;
                               dummy python:request.RESPONSE.setHeader('Content-Type', 'text/html;;charset=%s' % charset)"
              tal:attributes="content string:text/html;;charset=${charset}" />
    <style type="text/css" media="all"
              tal:define="current_skin python:ztu.make_query(skin=request.get(here.portal_skins.getRequestVarname(), ''))"
              tal:content="string: @import url(${here/portal_url}/plone.css?${current_skin});">
    </style>
</head>
    <body onload="focus();self.name='referencebrowser_popup'" style="margin: 4px;padding:0.5em;" 
              tal:define="allowed_types python:here.REQUEST.get('allowed_types').split(',');
                               search_text python:here.REQUEST.get('SearchableText', '');
                               multi python:here.REQUEST.get('multi', 0);
                               widget_id python:here.REQUEST.get('widget_id', '');
                               title python:here.REQUEST.get('ref_title', '');
                               description python:here.REQUEST.get('ref_description', '');">
    
        <!-- Search form -->
        <form action="search"
                  method="get"
                  name="search"
                  style="padding-bottom:1em;"
                  tal:define="DateTime python:modules['DateTime'].DateTime"
                  tal:attributes="action string: ${here/absolute_url}/${template/getId}">
    
            <h2 tal:content="title" />
            <p class="formHelp" 
                 style="font-size:110%"
                 tal:content="structure description"/>
            <p class="comment formHelp" 
                 style="font-size:100%; padding-top:0.5em;margin-top:1em;">
                   <span i18n:translate="referencebrowser_allowed_types">Object types you can refer to: </span>
                   <strong tal:condition="python: allowed_types==['']"
                               i18n:translate="referencebrowser_allowed_types_all">all</strong>
                   <strong tal:condition="python: allowed_types!=['']" tal:content="python:here.REQUEST.get('allowed_types').replace(',', ', ')"/>
            </p>
            <br />
            <div i18n:translate="referencebrowser_search_terms">Search Terms</div>
            <input type="text"
                   id="searchGadget"
                   name="SearchableText"
                   size="25"
                   tabindex=""
                   value=""
                   tal:attributes="value search_text"
                   />
            <tal:types tal:condition="python: allowed_types!=['']" tal:repeat="type allowed_types">
                <input type="hidden" name="portal_type:list" value="" tal:attributes="value type" />
            </tal:types>
            <input type="hidden" name="allowed_types" value="" tal:attributes="value python:','.join(allowed_types)" />    
            <input type="hidden" name="widget_id" value="" tal:attributes="value widget_id" />
            <input type="hidden" name="ref_title" value="" tal:attributes="value title" />
            <input type="hidden" name="ref_description" value="" tal:attributes="value description" />
            <input type="hidden" name="multi" value="" tal:attributes="value multi" />
            <input tabindex=""
                   class="searchButton"
                   type="submit"
                   name="submit"
                   value="Search"
                   i18n:attributes="value"
                   />
        </form>
    
        <!-- actual list of objects -->
        <tal:block tal:define="query_results python:[brain.getObject() for brain in here.queryCatalog()];">
            <div tal:condition="query_results">
                <span i18n:translate="referencebrowser_heading_search_results">Search results</span>
            </div>
            <!-- breadcrums -->
            <div style="border-top:1px solid black;border-bottom:1px solid black;"
                     tal:attributes="style string:border-top:1px solid ${here/base_properties/globalBorderColor};;
                                           border-bottom:1px solid ${here/base_properties/globalBorderColor};;
                                           margin-bottom:1em;;padding:0.2em 0 0.1em 0"
                     tal:condition= "not: query_results"
                     tal:define=     "parents request/PARENTS;
                                           nil python: parents.reverse();
                                           portal here/portal_url/getPortalObject;">
                <tal:crums tal:repeat="parent parents">
                    <img tal:condition="repeat/parent/start" 
                              tal:attributes="src string:${here/portal_url}/logoIcon.gif"/>
                    <tal:path tal:condition="not: repeat/parent/start">
                        <a tal:attributes="href python:parent.absolute_url() + '/' + template.getId() + '?allowed_types=' + ','.join(allowed_types) + '&multi='+multi+'&widget_id=' + widget_id + '&ref_title=' + title + '&ref_description=' + description">
                            <span tal:content="string: ${parent/title_or_id}"
                                        tal:condition="python: parent.absolute_url()!=portal.absolute_url()"/>
                            <span tal:content="string:Home" tal:condition="python: parent.absolute_url()==portal.absolute_url()"/>
                            <span class="breadcrumbSeparator" 
                                        tal:condition="not: repeat/parent/end" >&raquo;</span>
                        </a>
                    </tal:path>
                </tal:crums>
            </div>
        
           <!-- object list -->
           <tal:list tal:define="checkPermission python: here.portal_membership.checkPermission;
                                        results python: test(query_results, query_results,
                                        [item for item in here.listFolderContents()
                                        if checkPermission('View',item)]);">
    
                <table class="group" 
                          width="100%" 
                          cellspacing="0" 
                          cellpadding="2"
                          tal:condition="results">
                    <tbody>
                        <tal:results tal:repeat="item results">
                            <tal:row  tal:define="uid item/aq_explicit/UID|string:'';
                                                          item_referenceable python:(allowed_types!=[''] and (item.portal_type in allowed_types) or (allowed_types==['']));
                                                          has_uid python:hasattr(item.aq_explicit, 'UID');
                                                          referenceable python:has_uid and item_referenceable;
                                                          color here/base_properties/discreetColor;
                                                          color string:rgb(175,175,175);">
                                <tr tal:define="oddrow repeat/item/odd" 
                                     tal:attributes="class python:test(oddrow, 'even', 'odd')">
                                    <td width="50%">
                                        <img src="#" tal:attributes="src string:${here/portal_url}/${item/getIcon};alt item/Title" />
                                        <a tal:condition="python: item.isPrincipiaFolderish and item<>here"
                                             tal:attributes="href python:item.absolute_url() + '/' + template.getId() + '?allowed_types=' + ','.join(allowed_types) + '&multi='+multi+'&widget_id=' + widget_id + '&ref_title=' + title + '&ref_description=' + description">
                                            <strong tal:condition="referenceable"
                                                        tal:content="item/title_or_id">Title</strong>
                                            <span style="" tal:condition="not: referenceable" 
                                                                   tal:content="item/title_or_id"/>
                                        </a>
                                        <tal:foldercheck tal:condition="python: not (item.isPrincipiaFolderish and item &lt;&gt; here)" >
                                            <strong tal:condition="referenceable"
                                               tal:content="item/title_or_id">Title
                                            </strong>
                                            <span  style="" tal:condition="python:not referenceable" 
                                                                    tal:content="item/title_or_id"
                                                                    tal:attributes="style string:color:${color}" />
                                        </tal:foldercheck>
                                    </td>
                                    <td width="25%" style=""
                                          tal:attributes="style python:test(referenceable, '', 'color:' + color)"
                                          tal:content="python:item.getTypeInfo().Title()">Metatype
                                    </td>
                                    <td width="25%" nowrap="nowrap">
                                        <a href=""
                                            onclick=""
                                            tal:attributes="href string: #;
                                                                  onclick string: window.opener.referencebrowser_setReference('${widget_id}', '${uid}', '${item/title_or_id}', ${multi});; if (0==${multi}) {window.close()};; ;"
                                             tal:condition="referenceable">
                                            <strong i18n:translate="referencebrowser_insert_reference">Insert reference</strong>
                                        </a>
                                    </td>
                                </tr>
                            </tal:row>
                        </tal:results>
                    </tbody>
                </table>
            </tal:list>
        </tal:block>
        <br/><br/>
        <input type="button" 
                  value="Close window" 
                  class="standalone" 
                  onclick="javascript:window.close()"
                  i18n:attributes="value" />
    </body>
</html>
